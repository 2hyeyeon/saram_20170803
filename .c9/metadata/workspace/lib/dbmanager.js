{"filter":false,"title":"dbmanager.js","tooltip":"/lib/dbmanager.js","undoManager":{"mark":51,"position":51,"stack":[[{"group":"doc","deltas":[{"start":{"row":10,"column":0},"end":{"row":10,"column":43},"action":"remove","lines":["var UserDao= require('../dao/userDao.js'); "]}]}],[{"group":"doc","deltas":[{"start":{"row":9,"column":42},"end":{"row":10,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":228,"column":0},"action":"remove","lines":["// Author: 안정길 ","// Create Date: 2014.12.18","var xml_digester = require(\"xml-digester\");","var _ = require(\"underscore\"); ","var Promise = require('bluebird');","var mysql=Promise.promisifyAll(require('mysql'));","Promise.promisifyAll(require(\"mysql/lib/Connection\").prototype);","Promise.promisifyAll(require(\"mysql/lib/Pool\").prototype);","var fs = Promise.promisifyAll(require(\"fs\"));","var debug = require('debug')('DBManager');","","var path = require(\"path\");","var digester = xml_digester.XmlDigester({});","var DBManager = function () {","    var db=this;","    db.dbInfo = {","        // host: '10.0.0.1',","        // user: 'goodguy95',","        // password : 'yescnc113',","        // port : 3306,","        // database:'goodguy95'     ","       ","         host: '210.220.205.57',","         user: 'yes',","         password : 'yescnc1234',","         port : 3307,","         database:'yescnc_db'","        \t  ","        // host: 'localhost',","        // user: 'carran',","        // password : '',","        // port : 3306,","        // database:'c9'","        ","        // host: 'localhost',","        // user: 'carran',","        // password : '',","        // port : 3306,","        // database:'c9'","    };","    ","    var pool = mysql.createPool(db.dbInfo);","    db.pool=pool;","    ","    fs.readFileAsync(path.dirname(module.parent.filename) + \"/../xml/query.xml\",\"utf8\").then(function (data) {","        digester.digest(data, function(err, result) {","            if (err) { ","                debug(err);","            } else {","                for(var i = 0; i < result.querys.group.length; i++){","                    db.querys[result.querys.group[i].id] = result.querys.group[i].query;","                }","            }","        });","    }).catch(SyntaxError, function (e) {","        debug(\"file contains invalid file\");","    }).error(function (e) {","        debug(\"unable to read file, because: \", e.message);","    });","};","","DBManager.prototype.querys = [];","","DBManager.prototype.getDbInfo = function(){","    return this.dbInfo;","};","","DBManager.prototype.getQuery = function(groupid, id){","    var groupitem = this.querys[groupid];","    for(var i = 0; i< groupitem.length ; i++){","        var item = groupitem[i];","        if(item.id == id){","            return item._text;","        }","    }","    throw new Error('Can not find Query');","};","DBManager.prototype.getConnection = function(){","    var db= this;","    return new Promise(","        function(resolve, reject){","            db.pool.getConnectionAsync().then(function(connection){","                resolve(connection);","            }).catch(function(e){","                debug(\"Connection ERROR:\"+e.message);","                throw e;","            });","        }","    );","        ","};","","DBManager.prototype.queryTransaction = function(connection, queryStr, dataObj, schemaArr){","    return new Promise(","        function(resolve, reject){// promise patten","            connection.beginTransactionAsync().then(function(){","                var promiseArr = [];","                debug(\"DB Transaction Begin!\");","                for(var idx in dataObj){","                    var data = dataObj[idx];","                    var dataArr = [];","                    for(var i = 0; i < schemaArr.length; i++){","                        var key = schemaArr[i];","                        dataArr.push(data[key]);","                    }","                    promiseArr.push(connection.queryAsync(queryStr, dataArr).then(","                        function(result){","                            debug(\"Query : \" + queryStr);","                            debug(\"Data : \" + dataArr);","                            debug(result);","                        }, function(err){","                            debug(\"DB Query ERROR:\"+err.message);","                            throw err;","                        })","                    );","                }","                resolve(promiseArr);","            }).catch(function(e){","                debug(\"Transaction ERROR:\"+e.message);","                reject(e);","            });","        }","    ); ","};","","DBManager.prototype.queryV2 = function(queryStr, keyArr){","    var db=this;","    if(keyArr===\"\"||keyArr===undefined||keyArr===\"undefined\"||keyArr===null||keyArr===\"null\"){","        return new Promise(","            function(resolve, reject){// promise patten","                db.pool.getConnectionAsync().then(function(connection){//Connection Success","                    debug(\"Success get DB Connection\");","                    connection.queryAsync(queryStr).then(function(data){//Query Success","                        debug(queryStr);","                        var resultArr=data[0];","                        resolve(resultArr);     ","                        connection.release();","                    }).catch(function(e){//Query Error","                        debug(\"Query ERROR:\"+e.message);","                        connection.release();","                        reject(e);","                    });","                }).catch(function(e){//Connection Error","                   debug(\"Connection ERROR:\"+e.message);","                   reject(e);","                });","            }","        ); ","    }else{","        return new Promise(function(resolve, reject){// promise patten","            db.pool.getConnectionAsync().then(function(connection){//Connection Success","                debug(\"Success get DB Connection\");","                connection.queryAsync(queryStr, keyArr).then(function(data){//Query Success","                    debug(queryStr + \" [\"+keyArr+\"]\");","                    var resultArr=data[0];","                    resolve(resultArr);     ","                    connection.release();","                }).catch(function(e){//Query Error","                    debug(\"Query ERROR:\"+e.message);","                    connection.release();","                    reject(e);","                });","            }).catch(function(e){//Connection Error","               debug(\"Connection ERROR:\"+e.message);","               reject(e);","            });","        });    ","    }","};","","/**"," * 여러개의 데이터를 insert 할 경우"," * return {"," * \tresult: \"success\",\t// success / fail"," *  totalCount: datas.length,"," *  successCount: datas.length,"," *  failCount: 0,"," *  error: \"\""," * }"," * "," */","DBManager.prototype.insertQuerys = function(query, datas){","    var db = this,","    \tqueryResults = [],","    \tquerySuccessCount = 0,","    \tqueryResult = {","    \t\tresult: \"success\",\t// success / fail","    \t\ttotalCount: datas.length,","    \t\tsuccessCount: datas.length,","    \t\tfailCount: 0,","    \t\terror: \"\"","    \t};","    ","    return new Promise(function(resolve, reject){// promise patten","        db.pool.getConnectionAsync().then(function(connection){//Connection Success","        \tfor (var i = 0, len = datas.length; i < len; i++) {","        \t\tqueryResults.push(executeQuery(connection, query, datas[i]));","        \t}","        \t","            Promise.all(queryResults).then(function(result){","            \tresolve(queryResult);","            }).catch(function(e) {","            \tqueryResult.result = \"fail\";","            \tqueryResult.successCount = querySuccessCount;","            \tqueryResult.failCount = queryResult.totalCount - querySuccessCount;","            \tqueryResult.error = e;","            \t","            \treject(queryResult);","            }).finally(function() {","            \tconnection.release();","            });","        }); //Connection Success","    });","    ","    // SQL 실행","    function executeQuery(connection, query, data) {","    \treturn new Promise(function(resolve, reject){","    \t\tconnection.queryAsync(query, data).then(function(result) {","    \t\t\tquerySuccessCount++;","    \t\t\tresolve(result);","    \t\t}).catch(function(e) {","    \t\t\treject(e);","\t\t  });  ","\t  });","    }","};","","module.exports = new DBManager();",""]},{"start":{"row":0,"column":0},"end":{"row":232,"column":0},"action":"insert","lines":["// Author: 안정길 ","// Create Date: 2014.12.18","var xml_digester = require(\"xml-digester\");","var _ = require(\"underscore\"); ","var Promise = require('bluebird');","var mysql=Promise.promisifyAll(require('mysql'));","Promise.promisifyAll(require(\"mysql/lib/Connection\").prototype);","Promise.promisifyAll(require(\"mysql/lib/Pool\").prototype);","var fs = Promise.promisifyAll(require(\"fs\"));","var debug = require('debug')('DBManager');","","var path = require(\"path\");","var digester = xml_digester.XmlDigester({});","var DBManager = function () {","    var db=this;","    db.dbInfo = {","        host: '10.0.0.1',","        user: 'goodguy95',","        password : 'yescnc113',","        port : 3306,","        database:'goodguy95'     ","       ","        // host: '210.220.205.57',","        // user: 'yes',","        // password : 'yescnc1234',","        // port : 3307,","        // database:'yes'","        \t  ","        // host: 'localhost',","        // user: 'carran',","        // password : '',","        // port : 3306,","        // database:'c9'","        ","        // host: 'localhost',","        // user: 'carran',","        // password : '',","        // port : 3306,","        // database:'c9'","    };","    ","    var pool = mysql.createPool(db.dbInfo);","    db.pool=pool;","    ","    fs.readFileAsync(path.dirname(module.parent.filename) + \"/../xml/query.xml\",\"utf8\").then(function (data) {","        digester.digest(data, function(err, result) {","            if (err) { ","                debug(err);","            } else {","                for(var i = 0; i < result.querys.group.length; i++){","                    db.querys[result.querys.group[i].id] = result.querys.group[i].query;","                }","            }","        });","    }).catch(SyntaxError, function (e) {","        debug(\"file contains invalid file\");","    }).error(function (e) {","        debug(\"unable to read file, because: \", e.message);","    });","};","","DBManager.prototype.querys = [];","","DBManager.prototype.getDbInfo = function(){","    return this.dbInfo;","};","","DBManager.prototype.getQuery = function(groupid, id){","    var groupitem = this.querys[groupid];","    for(var i = 0; i< groupitem.length ; i++){","        var item = groupitem[i];","        if(item.id == id){","            return item._text;","        }","    }","    throw new Error('Can not find Query');","};","DBManager.prototype.getConnection = function(){","    var db= this;","    return new Promise(","        function(resolve, reject){","            db.pool.getConnectionAsync().then(function(connection){","                resolve(connection);","            }).catch(function(e){","                debug(\"Connection ERROR:\"+e.message);","                throw e;","            });","        }","    );","        ","};","","DBManager.prototype.queryTransaction = function(connection, queryStr, dataObj, schemaArr){","    return new Promise(","        function(resolve, reject){// promise patten","            connection.beginTransactionAsync().then(function(){","                var promiseArr = [];","                debug(\"DB Transaction Begin!\");","                for(var idx in dataObj){","                    var data = dataObj[idx];","                    var dataArr = [];","                    for(var i = 0; i < schemaArr.length; i++){","                        var key = schemaArr[i];","                        dataArr.push(data[key]);","                    }","                    promiseArr.push(connection.queryAsync(queryStr, dataArr).then(","                        function(result){","                            debug(\"Query : \" + queryStr);","                            debug(\"Data : \" + dataArr);","                            debug(result);","                        }, function(err){","                            debug(\"DB Query ERROR:\"+err.message);","                            throw err;","                        })","                    );","                }","                resolve(promiseArr);","            }).catch(function(e){","                debug(\"Transaction ERROR:\"+e.message);","                reject(e);","            });","        }","    ); ","};","","DBManager.prototype.queryV2 = function(queryStr, keyArr){","    var db=this;","    if(keyArr===\"\"||keyArr===undefined||keyArr===\"undefined\"||keyArr===null||keyArr===\"null\"){","        return new Promise(","            function(resolve, reject){// promise patten","                db.pool.getConnectionAsync().then(function(connection){ //Connection Success","\t\t\t\t\tdebug(\"Success get DB Connection\");","\t\t\t\t\tconnection.queryAsync(queryStr).then(function(data){//Query Success","\t\t\t\t\t\tdebug(queryStr);","\t\t\t\t\t\tvar resultArr=data[0];","\t\t\t\t\t\tresolve(resultArr);     ","\t\t\t\t\t\tconnection.release();","\t\t\t\t\t})","\t\t\t\t\t.catch(function(e){//Query Error","\t\t\t\t\t\tdebug(\"Query ERROR:\");","\t\t\t\t\t\tdebug(e);","\t\t\t\t\t\tconnection.release();","\t\t\t\t\t\treject(e);","\t\t\t\t\t});","\t\t\t","\t\t\t\t\t\t","\t\t\t\t})","\t\t\t\t.catch(function(e){//Connection Error","\t\t\t\t   debug(\"Connection ERROR:\"+e.message);","\t\t\t\t   reject(e);","\t\t\t\t});            ","\t\t\t}); ","    }else{","        return new Promise(function(resolve, reject){// promise patten","            db.pool.getConnectionAsync().then(function(connection){//Connection Success","                debug(\"Success get DB Connection\");","                connection.queryAsync(queryStr, keyArr).then(function(data){//Query Success","                    debug(queryStr + \" [\"+keyArr+\"]\");","                    var resultArr=data[0];","                    resolve(resultArr);     ","                    connection.release();","                }).catch(function(e){//Query Error","                    debug(\"Query ERROR:\"+e.message);","                    connection.release();","                    reject(e);","                });","            }).catch(function(e){//Connection Error","               debug(\"Connection ERROR:\"+e.message);","               reject(e);","            });","        });    ","    }","};","","/**"," * 여러개의 데이터를 insert 할 경우"," * return {"," * \tresult: \"success\",\t// success / fail"," *  totalCount: datas.length,"," *  successCount: datas.length,"," *  failCount: 0,"," *  error: \"\""," * }"," * "," */","DBManager.prototype.insertQuerys = function(query, datas){","    var db = this,","    \tqueryResults = [],","    \tquerySuccessCount = 0,","    \tqueryResult = {","    \t\tresult: \"success\",\t// success / fail","    \t\ttotalCount: datas.length,","    \t\tsuccessCount: datas.length,","    \t\tfailCount: 0,","    \t\terror: \"\"","    \t};","    ","    return new Promise(function(resolve, reject){// promise patten","        db.pool.getConnectionAsync().then(function(connection){//Connection Success","        \tfor (var i = 0, len = datas.length; i < len; i++) {","        \t\tqueryResults.push(executeQuery(connection, query, datas[i]));","        \t}","        \t","            Promise.all(queryResults).then(function(result){","            \tresolve(queryResult);","            }).catch(function(e) {","            \tqueryResult.result = \"fail\";","            \tqueryResult.successCount = querySuccessCount;","            \tqueryResult.failCount = queryResult.totalCount - querySuccessCount;","            \tqueryResult.error = e;","            \t","            \treject(queryResult);","            }).finally(function() {","            \tconnection.release();","            });","        }); //Connection Success","    });","    ","    // SQL 실행","    function executeQuery(connection, query, data) {","    \treturn new Promise(function(resolve, reject){","    \t\tconnection.queryAsync(query, data).then(function(result) {","    \t\t\tquerySuccessCount++;","    \t\t\tresolve(result);","    \t\t}).catch(function(e) {","    \t\t\treject(e);","\t\t  });  ","\t  });","    }","};","","module.exports = new DBManager();",""]}]}],[{"group":"doc","deltas":[{"start":{"row":232,"column":0},"end":{"row":233,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":233,"column":0},"end":{"row":233,"column":1},"action":"insert","lines":["2"]}]}],[{"group":"doc","deltas":[{"start":{"row":233,"column":0},"end":{"row":233,"column":1},"action":"remove","lines":["2"]}]}],[{"group":"doc","deltas":[{"start":{"row":136,"column":27},"end":{"row":137,"column":0},"action":"insert","lines":["",""]},{"start":{"row":137,"column":0},"end":{"row":137,"column":6},"action":"insert","lines":["\t\t\t\t\t\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":6},"end":{"row":138,"column":30},"action":"insert","lines":["debug(\"######################\");","\tdebug(process.memoryUsage());"]}]}],[{"group":"doc","deltas":[{"start":{"row":138,"column":1},"end":{"row":138,"column":5},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":138,"column":5},"end":{"row":138,"column":9},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":138,"column":9},"end":{"row":138,"column":13},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":138,"column":13},"end":{"row":138,"column":17},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":138,"column":17},"end":{"row":138,"column":21},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":6},"end":{"row":137,"column":38},"action":"remove","lines":["debug(\"######################\");"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":0},"end":{"row":137,"column":6},"action":"remove","lines":["\t\t\t\t\t\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":0},"end":{"row":138,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":27},"end":{"row":137,"column":28},"action":"insert","lines":["\""]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":28},"end":{"row":137,"column":29},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":29},"end":{"row":137,"column":30},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":30},"end":{"row":137,"column":31},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":31},"end":{"row":137,"column":32},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":32},"end":{"row":137,"column":33},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":33},"end":{"row":137,"column":34},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":34},"end":{"row":137,"column":35},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":35},"end":{"row":137,"column":36},"action":"insert","lines":["M"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":36},"end":{"row":137,"column":37},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":37},"end":{"row":137,"column":38},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":38},"end":{"row":137,"column":39},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":39},"end":{"row":137,"column":40},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":40},"end":{"row":137,"column":41},"action":"insert","lines":["y"]},{"start":{"row":137,"column":41},"end":{"row":137,"column":42},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":41},"end":{"row":137,"column":42},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":41},"end":{"row":137,"column":42},"action":"insert","lines":["\""]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":42},"end":{"row":137,"column":43},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":43},"end":{"row":137,"column":44},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":44},"end":{"row":137,"column":45},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":45},"end":{"row":137,"column":46},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":45},"end":{"row":137,"column":46},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":44},"end":{"row":137,"column":45},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":43},"end":{"row":137,"column":44},"action":"remove","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":43},"end":{"row":137,"column":44},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":44},"end":{"row":137,"column":45},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":44},"end":{"row":137,"column":45},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":43},"end":{"row":137,"column":44},"action":"remove","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":43},"end":{"row":137,"column":44},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":44},"end":{"row":137,"column":45},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":41},"end":{"row":137,"column":42},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":42},"end":{"row":137,"column":43},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":43},"end":{"row":137,"column":44},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":21},"end":{"row":137,"column":71},"action":"remove","lines":["debug(\"CurrentMemory : \" + process.memoryUsage());"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":0},"end":{"row":138,"column":0},"action":"remove","lines":["\t                    ",""]}]}],[{"group":"doc","deltas":[{"start":{"row":16,"column":8},"end":{"row":16,"column":11},"action":"insert","lines":["// "]},{"start":{"row":17,"column":8},"end":{"row":17,"column":11},"action":"insert","lines":["// "]},{"start":{"row":18,"column":8},"end":{"row":18,"column":11},"action":"insert","lines":["// "]},{"start":{"row":19,"column":8},"end":{"row":19,"column":11},"action":"insert","lines":["// "]},{"start":{"row":20,"column":8},"end":{"row":20,"column":11},"action":"insert","lines":["// "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":8},"end":{"row":22,"column":11},"action":"remove","lines":["// "]},{"start":{"row":23,"column":8},"end":{"row":23,"column":11},"action":"remove","lines":["// "]},{"start":{"row":24,"column":8},"end":{"row":24,"column":11},"action":"remove","lines":["// "]},{"start":{"row":25,"column":8},"end":{"row":25,"column":11},"action":"remove","lines":["// "]},{"start":{"row":26,"column":8},"end":{"row":26,"column":11},"action":"remove","lines":["// "]}]}]]},"ace":{"folds":[],"scrolltop":540,"scrollleft":0,"selection":{"start":{"row":57,"column":59},"end":{"row":57,"column":59},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":77,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1429494050305,"hash":"4bf61918dafd523d7d111d9a0ccc1a252005d03a"}