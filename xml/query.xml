<querys>
    <group id="user">
        <query id="selectUserList">
        	SELECT 
        		id, name, dept_code, (SELECT name FROM dept_code_tbl where code = dept_code) dept_name, name_commute, join_company, leave_company, privilege, admin
        	FROM members_tbl
        </query>
        <query id="selectIdByUser">select * from members_tbl where id=?</query>
        <query id="selectManager">select * from members_tbl where privilege &lt;= 2</query>
        <query id="insertUser">insert into members_tbl(id, name, dept_code, name_commute, join_company, privilege, admin) values(?,?,?,?,?, 0, 0)</query>
        <query id="initPassword">update members_tbl set password=? where id=?</query>
        <query id="deleteUser">delete from members_tbl where id=?</query>
    </group>
    
    <group id="data">
        <query id="select_user_all">select * from members_tbl</query>
    </group>
    
    <group id="dept">
        <query id="selectDeptList">SELECT code, name FROM dept_code_tbl</query>
        <query id="selectDeptList1">SELECT code, name FROM dept_code_tbl</query>
    </group>
    
    <group id="rawData">
        <query id="insertRawData">insert into commute_base_tbl(id, name, department, int_date, char_date, year, type) values(?,?,?,?,?,?,?)</query>
        <query id="selectRawDataList">select * from commute_base_tbl where int_date between ? and ? </query>
    </group>
    
    <group id="holiday">
        <query id="selectHolidayYearList">select distinct year from holiday_tbl</query>
        <query id="selectHolidayList">select * from holiday_tbl where year=?</query>
        <query id="insertHoliday">insert into holiday_tbl(year, date, memo) values(?, ?, ?)</query>
        <query id="deleteHoliday">delete from holiday_tbl where year=? and date=?</query>
	</group>
	
    <group id="vacation">
        <query id="selectVacationsByYear">
			SELECT 
				m.id, 
			    m.name,
			    (SELECT name FROM dept_code_tbl where code = m.dept_code) dept_name,
			    m.join_company,
				t2.year,
				t2.id,
				t2.total_day,
				t2.used_holiday,
			    (t2.total_day - t2.used_holiday) holiday
			FROM
				members_tbl m
			    INNER JOIN (
							SELECT
								v.year,
								v.id,
								v.total_day,
								IFNULL(s.used_holiday, 0) used_holiday
							FROM
								vacation_tbl v
								LEFT JOIN (
											SELECT year, id, sum(day_count)  used_holiday
											FROM out_office_tbl
											GROUP BY year, id
											) s
								ON v.id = s.id and v.year = s.year
							WHERE v.year = ?
			    ) t2
			    ON m.id = t2.id
			ORDER BY m.name
        </query>
        <query id="selectVacatonCount">
			SELECT count(*) count FROM vacation_tbl WHERE year = ?
        </query>
        
        <query id="insertVacation">
			INSERT INTO vacation_tbl(id, year, total_day)
			SELECT ?, ?, ? from dual
			WHERE NOT EXISTS (
					SELECT id
					FROM vacation_tbl
					WHERE 
						id = ?
			        AND 
			        	year = ? 
			)
        </query>

        <query id="updateVacation">
        	UPDATE 
        		vacation_tbl 
        	SET 
        		total_day = ? 
        	WHERE 
        		id = ? AND year = ?
        </query>
    </group>
    
    <group id="approval">
        <query id="selectApprovalList">
        	select 
        		app.doc_num
        		, app.submit_id, (SELECT mem.name FROM members_tbl mem WHERE mem.id = app.submit_id) submit_name 
        		, app.manager_id , (SELECT mem.name FROM members_tbl mem WHERE mem.id = app.manager_id) manager_name
        		, submit_date , decide_date , submit_comment , decide_comment , start_date , end_date , office_code
        		, (SELECT office.name FROM office_code_tbl office WHERE office.code = app.office_code) office_code_name
        		, state
    		from 
    			approval_tbl app
		</query>
        <query id="selectApprovalListWhere">
        	select 
        		app.doc_num
        		, app.submit_id, (SELECT mem.name FROM members_tbl mem WHERE mem.id = app.submit_id) submit_name 
        		, app.manager_id , (SELECT mem.name FROM members_tbl mem WHERE mem.id = app.manager_id) manager_name
        		, submit_date , decide_date , submit_comment , decide_comment , start_date , end_date , office_code
        		, (SELECT office.name FROM office_code_tbl office WHERE office.code = app.office_code) office_code_name
        		, state
    		from 
    			approval_tbl app
        	where (STR_TO_DATE(start_date,'%Y-%m-%d') between STR_TO_DATE(?,'%Y-%m-%d') AND STR_TO_DATE(?,'%Y/%m/%d'))
        	  OR (STR_TO_DATE(end_date,'%Y-%m-%d')  between STR_TO_DATE(?,'%Y-%m-%d') AND STR_TO_DATE(?,'%Y/%m/%d'))
    	</query>
    	<query id="insertApproval">
    		insert into approval_tbl
				(doc_num, submit_id, manager_id, submit_date, submit_comment, start_date, end_date, office_code, state) 
			values(?, ?, ?, NOW(), ?, ?, ?, ?, '상신')
    	</query>
    	<query id="updateApprovalConfirm">
    		update approval_tbl set 
    			decide_date = NOW()
    			,decide_comment = ?
    			,state = ? 
			where doc_num=?
    	</query>
	</group>
	
	<group id="approval_index">
		<query id="selectMaxIndexApproval">
			select MAX(seq) as maxSeq from approval_index_tbl where yearmonth=?
		</query>
		<query id="insertApprovalIndex">
			insert into approval_index_tbl (yearmonth, seq) values (?, 1)
		</query>
		<query id="updateMaxIndex">
			update approval_index_tbl set seq = (seq+1) where yearmonth=?
		</query>
	</group>
	
	<group id="office_code">
		<query id="selectOfficeCodeList">select * from office_code_tbl</query>
        <query id="empty"></query>
	</group>

    <group id="commute">
        <query id="selectCommute">
        SELECT
				c.year,
			    c.date,		
			    c.id,
			    c.department,
			    c.name,
				c.work_type,
                c.late_time,
                c.over_time,
			    date_format(c.in_time, '%Y-%m-%d %T') AS in_time,
			    date_format(c.out_time, '%Y-%m-%d %T') AS out_time,
			    c.in_time_change,
			    c.out_time_change,
			    c.comment_count,
                o.name as overtime_type,
                o.overtime_pay,
                (select name from office_code_tbl where code = c.vacation_code) as vacation_name,
                (select name from office_code_tbl where code = c.out_office_code) as out_office_name
                
			FROM 
				commute_result_tbl c
                left join overtime_code_tbl o on c.overtime_code = o.code
			WHERE
				date BETWEEN ? AND ?
			ORDER BY date
        </query>

        <query id="updateCommuteResultInOutTime">
        	UPDATE 
        		commute_result_tbl 
        	SET 
        		in_time = ?,
        		in_time_change = ?,
        		out_time = ?,
        		out_time_change = ?
        	WHERE 
        		id = ? AND year = ? AND date = ?
        </query>
        
        <query id="insetCommuteResult">
        	INSERT INTO commute_result_tbl
        		(date, department, id, in_time, late_time, name, out_office_code, out_time, over_time, overtime_code, vacation_code, standard_in_time, standard_out_time, work_type, year)
        	VALUES
        		(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
        	ON DUPLICATE KEY UPDATE
				department=?,
				in_time=?,
				late_time=?,
				name=?,
				out_office_code=?,
				out_time=?,
				over_time=?,
				overtime_code=?,
				vacation_code=?,
				standard_in_time=?,
				standard_out_time=?,
				work_type=?

        	
        </query>
        <query id="selectCommuteDate">
        	SELECT 
        		year,
        		date,
        		id,
        		name,
        		department,
        		date_format(in_time, '%Y-%m-%d %T') AS in_time,
        		date_format(out_time, '%Y-%m-%d %T') AS out_time,
        		date_format(standard_in_time, '%Y-%m-%d %T') AS standard_in_time,
        		date_format(standard_out_time, '%Y-%m-%d %T') AS standard_out_time,
				late_time,
				over_time,
				work_type,
				out_office_code,
				overtime_code,
				vacation_code
        	FROM
        		commute_result_tbl
        	WHERE
        		date = ?
        </query>
    </group>
    
    <group id="changeHistory">
    	<query id="selectChangeHistory">
			SELECT
					c.seq,
					c.year,
			        c.id,
			        m.name,
			        c.date,
			        c.change_column,
			        c.change_before,
			        c.change_after,
			        c.change_date,
			        c.change_id,
			        (SELECT name FROM members_tbl WHERE id = c.change_id) AS change_name
			FROM
				change_history_tbl c
                inner join members_tbl m 
                on c.id = m.id
			WHERE
				c.id = ?
			    AND c.date = ?
			    AND c.change_column = ?
			ORDER BY c.seq
    	</query>
    	
        <query id="selectInOutChangeCount">
			select (
			            select count(*) 
			            from change_history_tbl
			            where
							year = ?
			                and id = ?
			                and date = ?
			                and change_column = 'in_time'
					) as in_time_change_count,
			        (
			            select count(*) 
			            from change_history_tbl
			            where
							year = ?
			                and id = ?
			                and date = ?
			                and change_column = 'out_time'
					) as out_time_change_count        
			from dual;        
        </query>    	
    	
    	<query id="inserChangeHistory">
			INSERT INTO change_history_tbl
			(
				year, id, date,	change_column, change_before, change_after, change_date, change_id
			)
			values
			(
				?, ?, ?, ?, ?, ?, now(), ?			
			);
    	</query>
    </group>
    
    <group id="outOffice">
    	<query id="selectOutOfficeList">
    		select * from out_office_tbl;
    	</query>
    	<query id="empty"></query>
    </group>
</querys>